server:
  port: 8080
  forward-headers-strategy: framework

spring:
  main:
    web-application-type: reactive
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: http://keycloak:8080/realms/master
  cloud:
    gateway:
      discovery:
        locator:
          enabled: true
          lower-case-service-id: true
      routes:
        # Admin Service Routes
        - id: his-admin-api
          uri: lb://his-admin-api
          predicates:
            - Path=/admin/**
          filters:
            - name: CircuitBreaker
              args:
                name: adminApiCB
                fallbackUri: forward:/fallback/admin
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        - id: his-admin-api-docs
          uri: lb://his-admin-api
          predicates:
            - Path=/v3/api-docs/admin/**
          filters:
            - RewritePath=/v3/api-docs/admin(?<segment>/?.*), /api-docs${segment}

        # AR Service Routes
        - id: his-ar-api
          uri: lb://his-ar-api
          predicates:
            - Path=/ar/**
          filters:
            - name: CircuitBreaker
              args:
                name: arApiCB
                fallbackUri: forward:/fallback/ar
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        - id: his-ar-api-docs
          uri: lb://his-ar-api
          predicates:
            - Path=/v3/api-docs/ar/**
          filters:
            - RewritePath=/v3/api-docs/ar(?<segment>/?.*), /api-docs${segment}

        # DC Service Routes
        - id: his-dc-api
          uri: lb://his-dc-api
          predicates:
            - Path=/dc/**
          filters:
            - name: CircuitBreaker
              args:
                name: dcApiCB
                fallbackUri: forward:/fallback/dc
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        - id: his-dc-api-docs
          uri: lb://his-dc-api
          predicates:
            - Path=/v3/api-docs/dc/**
          filters:
            - RewritePath=/v3/api-docs/dc(?<segment>/?.*), /api-docs${segment}

        # ED Service Routes
        - id: his-ed-api
          uri: lb://his-ed-api
          predicates:
            - Path=/ed/**
          filters:
            - name: CircuitBreaker
              args:
                name: edApiCB
                fallbackUri: forward:/fallback/ed
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        - id: his-ed-api-docs
          uri: lb://his-ed-api
          predicates:
            - Path=/v3/api-docs/ed/**
          filters:
            - RewritePath=/v3/api-docs/ed(?<segment>/?.*), /api-docs${segment}

        # CO Service Routes
        - id: his-co-api
          uri: lb://his-co-api
          predicates:
            - Path=/co/**
          filters:
            - name: CircuitBreaker
              args:
                name: coApiCB
                fallbackUri: forward:/fallback/co
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        - id: his-co-api-docs
          uri: lb://his-co-api
          predicates:
            - Path=/v3/api-docs/co/**
          filters:
            - RewritePath=/v3/api-docs/co(?<segment>/?.*), /api-docs${segment}

        # BI Service Routes
        - id: his-bi-api
          uri: lb://his-bi-api
          predicates:
            - Path=/bi/**
          filters:
            - name: CircuitBreaker
              args:
                name: biApiCB
                fallbackUri: forward:/fallback/bi
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        - id: his-bi-api-docs
          uri: lb://his-bi-api
          predicates:
            - Path=/v3/api-docs/bi/**
          filters:
            - RewritePath=/v3/api-docs/bi(?<segment>/?.*), /api-docs${segment}

        # Reports Service Routes
        - id: his-reports-api
          uri: lb://his-reports-api
          predicates:
            - Path=/reports/**
          filters:
            - name: CircuitBreaker
              args:
                name: reportsApiCB
                fallbackUri: forward:/fallback/reports
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
        - id: his-reports-api-docs
          uri: lb://his-reports-api
          predicates:
            - Path=/v3/api-docs/reports/**
          filters:
            - RewritePath=/v3/api-docs/reports(?<segment>/?.*), /api-docs${segment}
            
        # Auth Service Routes
        - id: his-auth-service
          uri: lb://his-auth-service
          predicates:
            - Path=/auth/**
          filters:
            - name: CircuitBreaker
              args:
                name: authServiceCB
                fallbackUri: forward:/fallback/auth
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 20
                redis-rate-limiter.burstCapacity: 40
        - id: his-auth-service-docs
          uri: lb://his-auth-service
          predicates:
            - Path=/v3/api-docs/auth/**
          filters:
            - RewritePath=/v3/api-docs/auth(?<segment>/?.*), /api-docs${segment}

eureka:
  client:
    service-url:
      defaultZone: http://his-service-registry:8761/eureka/
  instance:
    prefer-ip-address: true

springdoc:
  swagger-ui:
    urls:
      - name: admin
        url: /v3/api-docs/admin
      - name: ar
        url: /v3/api-docs/ar
      - name: bi
        url: /v3/api-docs/bi
      - name: co
        url: /v3/api-docs/co
      - name: dc
        url: /v3/api-docs/dc
      - name: ed
        url: /v3/api-docs/ed
      - name: reports
        url: /v3/api-docs/reports
      - name: auth
        url: /v3/api-docs/auth
  forward-headers:
    - X-Forwarded-Host
    - X-Forwarded-Port
    - X-Forwarded-Proto
    - X-Forwarded-For

resilience4j:
  circuitbreaker:
    configs:
      default:
        slidingWindowSize: 10
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3
        minimumNumberOfCalls: 5
  timelimiter:
    configs:
      default:
        timeoutDuration: 3s
